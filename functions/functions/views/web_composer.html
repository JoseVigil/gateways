<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">     
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="stylesheet" href="/vendor/colorPicker/css/bootstrap-colorpicker.css">
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
     <link rel='icon' href='https://vigil.com.ar/favicons/notimation.ico' type='image/x-icon' />
     
     <title>Noti.ms</title>
  
      <style>  
    
        .column-background {
          background-color: #fff; border-radius: 5px; padding: 20px; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        }

        .droppable-active { background-color: #ffe !important; }
        .tools a { cursor: pointer; font-size: 80%; }
        .form-body .col-md-6, .form-body .col-md-12 { min-height: 800px; }
        .draggable { cursor: move; }

        hr {
          margin-top: 1rem;
          margin-bottom: 1rem;
          border: 0;
          border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .checkbox {
          padding-left: 10px;
          padding-right: 10px;
        }
        
        .form-composer {
          padding-left:15px;
        }        
      
     </style>

  </head>

  <body>       
     
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/lr9wasio09vwo6la4k91gs8hybva1vp7oxw5k9cfpm2g5pm6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>            
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-functions.js"></script>   


    <script src="/vendor/colorPicker/js/bootstrap-colorpicker.js"></script>

    <div id="login">
      Web Composer - Not Logged
    </div>  
    
    <div class="container-fluid">
      
      <div class="row">
        <div class="col-md-3">

          <div id="html-preview" class="column-background">
            <div class="tabbable" id="tabs-381741">
              <ul class="nav nav-tabs">
                <li class="nav-item">
                  <a class="nav-link active" href="#preview-tab" data-toggle="tab">Preview</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#web-tab" data-toggle="tab">Web</a>
                </li>                
              </ul>
              <div class="tab-content">
                
                <div id="preview-tab" class="tab-pane active">
                  
                  <form id="form-composer-preview" role="form">
                    
                    <br>

                    <div id="llamada" class="form-group draggable">
                      <label for="llamada" ><b>Llamada</b></label>
                      <input type="text" class="form-control" id="inllamada">
                      <p class="help-block">Crear llamada a la acci√≥n</p>
                    </div>

                    <div id="mensaje" class="form-group draggable">
                      <label for="mensaje" ><b>Mensaje</b></label>  
                      <input type="text" class="form-control">
                      <p>Crea el mensaje</p>                        
                    </div>

                    <div id="fondo" class="form-group draggable">
                      <label for="fondo" ><b>Imagen de fondo</b></label>                                            
                      <input id="infondo" type="file" accept=".jpg, .jpeg, .png">
                    </div>

                    <div id="pie" class="form-group draggable">
                      <label for="pie" ><b>Pie de preview</b></label>
                      <div class="control-group">                        
                        <div class="controls span2">
                            <label class="checkbox">
                              <input type="checkbox" id="inInfo"> + info
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inConocer"> Conocer mas
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inFinanciar"> Financiar
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inDesuscribir"> Desuscribir
                            </label>                            
                        </div>                        
                      </div>
                      <p class="help-block">Pie de preview</p>
                    </div>                    

                  </form>

                </div>

                <div id="web-tab" class="tab-pane">

                  <form id="form-composer-web" role="form">
                    
                    <br>

                    <div id="saludo" class="form-group draggable">
                      <label for="saludo" ><b>Saludo</b></label>
                      <input type="text" class="form-control" id="insaludo">
                      <p class="help-block">Saludo de cortecia</p>
                    </div>
                   
                    <div id="cuerpo" class="form-group draggable">
                      <label for="cuerpo" ><b>Cuerpo</b></label>  
                      <input type="text" class="form-control">
                      <p>Crea el cuerpo del mensaje</p>                        
                    </div>                    
                    

                    <div id="contacto" class="form-group draggable">
                      <label for="contacto" ><b>Contacto</b></label>
                      <div class="control-group">                        
                        <div class="controls span2">
                            <label class="checkbox">
                              <input type="checkbox" id="inGrabar"> Grabar mensaje
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inLlamar"> Llamame
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inWhatsapp"> Whatsapp
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inEmail"> Email
                            </label>                            
                        </div>                        
                      </div>
                      <p class="help-block">Modo de contacto</p>
                    </div>

                    <div id="pagos" class="form-group draggable">
                      <label for="pagos" ><b>Pagos</b></label>
                      <input type="text" class="form-control" id="inpagos">
                      <div class="control-group">                        
                        <div class="controls">
                            <div class="row">
                              <label class="checkbox">
                                  <input type="checkbox" id="inMercado"> Mercadopago
                              </label>                              
                              <label class="checkbox">
                                  <input type="checkbox" id="inRapi"> Rapipago
                              </label>
                            </div>
                            <div class="row">
                              <label class="checkbox">
                                  <input type="checkbox" id="inFacil"> Pago Facil
                              </label>
                              <label class="checkbox">
                                <input type="checkbox" id="inOtros"> Otros
                              </label>           
                            </div>                   
                        </div>                        
                        </div>                                                          
                        <p class="help-block">Medio de pago</p>
                    </div>  

                    <div id="facturas" class="form-group draggable">
                      <label for="facturas" ><b>Detalle de facturas</b></label>
                      <input type="text" class="form-control" id="infacturas">
                      <div class="control-group">                        
                        <div class="controls">
                            <div class="row">                                                           
                              <label class="checkbox">
                                <input type="checkbox" id="inMonto"> Monto
                              </label> 
                              <label class="checkbox">
                                <input type="checkbox" id="inDetalle"> Ver detalle
                              </label>
                              <label class="checkbox">
                                  <input type="checkbox" id="inDescargar"> Descargar PDF
                              </label>                                                            
                            </div>                                             
                          </div>                        
                        </div>                                                          
                        <p class="help-block">Detalle de facturas</p>
                    </div>  
                    
                    <div id="imagen" class="form-group draggable">
                      <label for="imagen" ><b>Imagen</b></label>
                      <input id="inimagen" type="file" name="files[]">
                      <p class="help-block">Agregar imagen</p>
                    </div>

                    <div id="color" class="form-group draggable">
                      <label for="color" ><b>Color de fondo</b></label>                   
                      <input type="text" value="rgb(0, 0, 0)" />
                      <p class="help-block">Cambiar color de fondo</p>                    
                    </div>
                  
                  </form>

                </div>
                <div class="tab-pane" id="tab2">
                  <p>
                    Howdy, I'm in Section 2.
                  </p>
                </div>
              </div>
            </div>

            <button id="save-web" type="button" class="btn btn-success">
              Guardar Dise√±o Web
            </button>
            
          </div> 
          
          
        </div>
        <div class="col-md-5">

          <div class="column-background" style="font-size: 15px;">
            <label>Arrastrar y soltar elementos en los campos.</label>
            <div class="row" id="composer"></div>
            <hr/>
            <div class="row form-body">
              <div id="drop-area" class="col-md-12 droppable sortable">
              </div>              
            </div>

        </div>
          
        </div>       
        <div class="col-md-4">
          <div class="column-background">
            <div class="form-group draggable">
              <div id="preview">            
                
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Alert -->  
      <div id="alertModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">                                
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <p id="alert-content"></p>
                </div>                                
                <div data-dismiss="modal" class="modal-footer"><button type="button" class="btn btn-primary">OK</button></div>
            </div>
        </div>
      </div>
     
    </div>

    <script>
    //<![CDATA[


    /**
     * PDF TO HTML
     * 
     * https://www.idrsolutions.com/online-pdf-to-html5-converter
     * 
     * */

    /**
     * Drag and drop
     * http://jsfiddle.net/vacidesign/uskx816g/
     * */

    /**
     * jquery Uncaught SyntaxError: "Unexpected token '<'"
     * https://idiallo.com/javascript/uncaught-syntaxerror-unexpected-token#n
     * 
     * */

    /**
     * Stepper into modal
     * 
     * https://bbbootstrap.com/snippets/modal-dialog-multi-step-form-wizard-29726524
     * */

    $(document).ready(function () {            

      //var active.saludo = false;
      //var active.cuerpo = false;
      //var active.from_button = false;

      var active = {
        saludo:false,
        cuerpo: false,
        from_button:false,
        facturas:false
      };

      var target_result;

      var data;
      var count_drop = 0;

      var noti_html;

      const firebaseConfig = {
        apiKey: "AIzaSyAM4WQDHpHh1oRT_v-6ikquE4V809hA3kY",
        authDomain: "notims.firebaseapp.com",
        databaseURL: "https://notims.firebaseio.com",
        projectId: "notims",
        storageBucket: "notims.appspot.com",
        messagingSenderId: "79471870593",
        appId: "1:79471870593:web:ef29a72e1b1866b2bb4380",
        measurementId: "G-8T5N81L78J"
      };
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      const database = firebase.database();
      const functions = firebase.functions();

      var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
      };         
      
    
      $( "#login" ).click(function() {    

        firebase.auth()
        .signInWithEmailAndPassword("josemanuelvigil@gmail.com", "master")
        .then(function(user) {   

            console.log(user.id);
            window.location.reload();     

        }).catch( function(error) {                         
            var errorMessage = error.message;  
            console.log(errorMessage);
        });

      });        
    
      firebase.auth().onAuthStateChanged(function (user) {

        if (user) { 

          $("#login").text("Web Composer - Logged");

          window.type = getUrlParameter('type');
          window.account = getUrlParameter('account');         
          window.campaignId = getUrlParameter('campaignId');  
          window.designId = getUrlParameter('designId'); 

          if (window.type=="web") {
            $('a[href="#web-tab"]').tab('show');
          } else if (window.type=="preview") {
            $('a[href="#preview-tab"]').tab('show');            
          }

          window.documentPath = `accounts/${window.account}/campaigns/${window.campaignId}`; ///web/sample`;
          
          db.doc(window.documentPath).get()
              .then(function(doc) {   
                
                if (doc.exists) {

                  var name =  doc.data().name;                
                  var fields =  doc.data().fields;                             

                  let json = `{`;

                  var count = 0;
                  var length = fields.length;
                  
                  for (var i=0; i<length; i++) {

                      let field = fields[i];                      
                      let name = field.name;
                      let value = field.value;

                      var button;
                      switch (i) {
                        case 0:
                          button = "btn-primary";
                        break;
                        case 1:
                          button = "btn-secondary";
                        break;
                        case 2:
                          button = "btn-success";
                        break;
                        case 3:
                          button = "btn-warning";
                        break;
                        case 4:
                          button = "btn-info";
                        break;
                        default:
                          button = "btn-dark";
                          break;
                      }

                      json += ` "${name}" :  { 
                          "datos" : "${value}", 
                          "boton" : "${button}"
                      }`;

                      if (count === (length-1)) {
                        json += `}`;
                      } else {
                        json += `,`;
                      }
                      count++;
                  } 

                  data = JSON.parse(json);            

                  for (var key of Object.keys(data)) {
                    
                    let nombre = key;
                    let datos = data[key]["datos"];
                    let boton = data[key]["boton"];

                    let _html = `&nbsp;&nbsp<button data-field="${datos}" style="color:white" class="botones btn ${boton}" type="button" id="${nombre}">${nombre}</button>&nbsp;&nbsp`;
              
                    $("#composer").append(_html);

                    $("#" + nombre).on('click', function (e) {                     
                      
                      e.preventDefault();
                      active.from_button = true;

                      var timer_click = setTimeout(function() {                                                           
                      
                        var id = $(e.target).attr('id'); 
                        var variable;
                        variable = "{" + nombre + "}";                      

                        if (active.saludo) {

                          let cursorPos = $('#insaludo').prop('selectionStart');
                          let v = $('#insaludo').val();
                          let textBefore = v.substring(0,  cursorPos );
                          let textAfter  = v.substring( cursorPos, v.length );
                          $('#insaludo').val( textBefore + variable + textAfter ); 

                        } else if (active.cuerpo) {                
                        
                          tinymce.activeEditor.execCommand('mceInsertContent', false, variable);
                        
                        } else if (active.facturas) {

                          let cursorPos = $('#infacturas').prop('selectionStart');
                          let v = $('#infacturas').val();
                          let textBefore = v.substring(0,  cursorPos );
                          let textAfter  = v.substring( cursorPos, v.length );
                          $('#infacturas').val( textBefore + variable + textAfter ); 

                        }

                        clearTimeout(timer_click);

                      }, 200);

                    });

                  }

                  window.docDesign = doc;
                  LoadTypes(doc);
                                  
              }
          });  
          
          
          var LoadTypes = function(doc) {

            doc.ref.collection("designs") 
                .doc(window.designId).get()
                .then(function(docWeb) { 

                  if (docWeb.exists) {                        

                    let inputs_web_base = docWeb.data().inputs_web; 

                    if (inputs_web_base != undefined) {
                      
                      let html = docWeb.data().html_web;
                      let public_image_web = docWeb.data().public_image_web;
                      let img = `<img src="${public_image_web}"/>`;
                      
                      $("#web-image").remove();
                      $("#web").append(img);

                      if (window.type=="web") {                         

                        let modules_web = docWeb.data().inputs_web;                             
                        var mlength = Object.keys(modules_web).length;
                        
                        if ( mlength > 0 ) {

                            var flags_web = [];                                     

                            for ($m in modules_web) {

                              let module_web = modules_web[$m];
                              
                              var $orig, name, flag;

                              switch (module_web.key) {

                                case "saludo":
                                  $orig = $("#saludo");                                                                
                                  flag = 1;
                                  break;

                                case "cuerpo":
                                  $orig = $("#cuerpo");                                                                
                                  flag = 2;                                
                                  break;

                                case "contacto":
                                  $orig = $("#contacto");                                                                
                                  flag = 3;                                
                                  break;

                                case "pagos":
                                  $orig = $("#pagos");                                                                
                                  flag = 4;                                
                                  break;

                                case "facturas":
                                  $orig = $("#facturas");                                                                
                                  flag = 5;                                
                                  break;

                                case "color":
                                  $orig = $("#color");                                                                
                                  flag = 6;                                
                                  break;
                              }

                              name = module_web.key;

                              var $ele = $orig.clone()
                                .addClass("dropped")
                                .css({"position": "static", "left": null, "right": null})                            
                                .appendTo( "#drop-area" );

                              drop($ele, name, $orig);                        
                              
                              flags_web[flag]= [module_web.value, $ele]; 

                            } 
                            
                            var wtimer = setTimeout(function() { 

                              for (flag in flags_web) { 
                                
                                  let value = flags_web[flag][0];
                                  let $ele  = flags_web[flag][1];

                                  let f = parseInt(flag);

                                  switch (f) {
                                      case 1:
                                        $ele.find("#insaludo").val(value);
                                      break;
                                      case 2:                                      
                                        tinymce.activeEditor.setContent(value);
                                      break;
                                      case 3:                                      
                                        $ele.find('#inGrabar').prop('checked', value.rec);
                                        $ele.find('#inLlamar').prop('checked', value.call);
                                        $ele.find('#inWhatsapp').prop('checked', value.wa);
                                        $ele.find('#inEmail').prop('checked', value.email);
                                        break;
                                      case 4:                               
                                        $ele.find('#inMercado').prop('checked', value.rec);
                                        $ele.find('#inRapi').prop('checked', value.call);
                                        $ele.find('#inFacil').prop('checked', value.wa);
                                        $ele.find('#inOtros').prop('checked', value.email);
                                        break;
                                      case 5:                                                                           
                                        $ele.find('#inDescargar').prop('checked', value.des);
                                        $ele.find('#inDetalle').prop('checked', value.det);                                            
                                        $ele.find('#inMonto').prop('checked', value.mon);   
                                        if (value.tit) {
                                          $ele.find("#infacturas").val(value.tit);                                         
                                        }                                        
                                        break;
                                      case 6:
                                        $ele.find("#incolor").val(value);
                                        break;
                                  }
                              }

                              getInputsHTML();

                              clearTimeout(wtimer);

                            }, 500);

                        } 

                    } else if (window.type=="preview") {                             

                        let modules_preview = docWeb.data().modules_preview;

                        var plength = Object.keys(modules_preview).length;
                        
                        if (plength > 0 ) {

                          var flags_preview = [];                                     

                          for ($m in modules_preview) {

                            let module_preview = modules_preview[$m];

                            var $orig, name, flag;

                            switch (module_preview.key) {

                              case "llamada":
                                $orig = $("#llamada");                                                                
                                flag = 1;
                                break;

                              case "mensaje":
                                $orig = $("#mensaje");                                                                
                                flag = 2;                                
                                break;

                              case "fondo":
                                $orig = $("#fondo");                                                                
                                flag = 3;                                
                                break;

                              case "pie":
                                $orig = $("#pie");                                                                
                                flag = 4;                                
                                break;

                            }

                            name = module_preview.key;

                            var $ele = $orig.clone()
                              .addClass("dropped")
                              .css({"position": "static", "left": null, "right": null})                            
                              .appendTo( "#drop-area" );

                            drop($ele, name, $orig);                        
                            
                            flags_preview[flag] = [module_preview.value, $ele]; 

                          } 

                          var ptimer = setTimeout(function() { 

                            for (flag in flags_preview) { 
                              
                                let value = flags_preview[flag][0];
                                let $ele  = flags_preview[flag][1];

                                let f = parseInt(flag);

                                switch (f) {
                                    case 1:
                                      $ele.find("#inllamada").val(value);
                                    break;
                                    case 2:                                      
                                      tinymce.activeEditor.setContent(value);
                                    break;
                                    case 3:                                      
                                      $ele.find('#inGrabar').prop('checked', value.rec);
                                      $ele.find('#inLlamar').prop('checked', value.call);
                                      $ele.find('#inWhatsapp').prop('checked', value.wa);
                                      $ele.find('#inEmail').prop('checked', value.email);
                                      break;
                                    case 4:                               
                                      $ele.find('#inMercado').prop('checked', value.rec);
                                      $ele.find('#inRapi').prop('checked', value.call);
                                      $ele.find('#inFacil').prop('checked', value.wa);
                                      $ele.find('#inOtros').prop('checked', value.email);
                                      break;                                       
                                    case 5:
                                      $ele.find("#incolor").val(value);
                                      break;
                                }
                            }

                            getInputsHTML();

                            clearTimeout(ptimer);

                          }, 500);

                        } 
                    }
                  }
                }
            });  

          }
          
          $( "#preview-tab" ).click(function() { 
            
            count_drop=0;
            window.type = "preview";
            LoadTypes(window.docDesign);

          });

          $( "#web-tab" ).click(function() {
            
            count_drop=0;
            window.type = "web";
            LoadTypes(window.docDesign);

          });


          $("#save-web").on('click', async function() {                                  
            
              let inputsHtml = await getInputsHTML();  

              let _html_ = inputsHtml[0];
              var modules = inputsHtml[1];

              var background_color; 
              for ($m in modules) {
                let module = modules[parseInt($m)];                              
                if (module.key == "color") {
                  background_color = module.value;
                }
              }             
                
              var _html = _html_.replace(/\n|\t/g, ' '); //break    
              _html = _html.replace(/\>[\t ]+\</g, "><");  // whitespace between tags       

              var _time =  new Date();   
              
              var image_width         = $("#preview").width();
              var image_height        = $("#preview").height() + 60;
              //var image_name          = "sample"; //CAMBIAR

              let docPath = window.documentPath + "/designs/" + window.designId;              
              const encodedPath = window.btoa(docPath);

              var webRef = db.doc(docPath);  

              let payload = {        
                html_web: _html,
                inputs_web: modules,                
                encoded_path: encodedPath,
                image_width_web: image_width,
                image_height_web: image_height,
                last_update: _time,                
                web_update: true                
              };

              if (background_color) {
                payload.background_color_web = background_color;
              }              

              webRef.set(payload,{ merge: true }).then(docRefSet => {

                  $('#alert-content').text('La web de la campa√±a ' + window.camapignId + ' se ha guardado con exito.');
                  $('#alertModal').modal('show');

                  /*
                  var image_storage_path  = `accounts/${account}/campaigns/${window.camapignId}`;           
                  var type = "web";

                  let post_params = { 
                    url: _html,                     
                    background_color: background_color,             
                    image_width: image_width,
                    image_height: image_height,
                    image_name: image_name,
                    image_storage_path: image_storage_path,
                    account: window.account,
                    campaign: window.camapignId,
                    type: type,
                    design: image_name                                             
                  };

                  var urdl = "http://localhost:5001/notims/us-central1/buildimage";
                  //var urdr = "https://us-central1-notims.cloudfunctions.net/buildimage";       

                  var params = JSON.stringify(post_params);

                  console.log("params: " + params);

                  var settings = {
                  "url": urdl,
                  "method": "POST",
                  "timeout": 0,
                  "headers": {
                    "Content-Type": "application/json"
                  },
                  "data": params,
                };

                $.ajax(settings).done(function (response) {
                  
                  console.log(response);
                  if (response.data.result) {        

                  }             

                });*/            
                
              }).catch((error) => {     
                console.error("Error adding document: ", error);           
              }); 
              
              function reverseArr(input) {
                  var ret = new Array;
                  for(var i = input.length-1; i >= 0; i--) {
                      ret.push(input[i]);
                  }
                  return ret;
              }

          });
       
          $( ".draggable" ).draggable({
            appendTo: "body",
            helper: "clone"
          });
          
          $( ".droppable" ).droppable({
            accept: ".draggable",
            helper: "clone",
            hoverClass: "droppable-active",
            drop: function( event, ui ) {
              
              $(".empty-form").remove();
              var $orig = $(ui.draggable);
              
              if(!$(ui.draggable).hasClass("dropped")) {               

                var name = $orig.find("label").attr("for");                      
                
                var $el = $orig
                  .clone()
                  .addClass("dropped")
                  .css({"position": "static", "left": null, "right": null})
                  .appendTo(this);
                  
                  drop($el, name, $orig);                
               
              } else {
               
                if($(this)[0]!=$orig.parent()[0]) {
                
                  var $el = $orig
                    .clone()
                    .css({"position": "static", "left": null, "right": null})
                    .appendTo(this);
                  $orig.remove();

                }

              }
            }
          }).sortable();

          var drop = async function ($el, name, $orig) {

                count_drop++;

                if (window.type=="web") {

                  switch(name) {

                    case "saludo":
                      $el.find("p").remove();
                      break;
                    case "cuerpo":
                      $el.find("p").remove();                   
                      $el.find("input").replaceWith(`<textarea id="incuerpo"></textarea>`);                              
                      $el.find("textarea").removeAttr('placeholder');
                      initTinyEMC();
                      break;
                    case "contacto":
                      $el.find("p").remove();   
                      $('#contacto input[type="checkbox"]').click(function(){
                        getInputsHTML();
                      });         
                      break;
                    case "pagos":
                      $el.find("p").remove();      
                      $('#pagos input[type="checkbox"]').click(function(){
                        getInputsHTML();
                      });
                      break;
                    case "facturas":
                      $el.find("p").remove();      
                      $('#facturas input[type="checkbox"]').click(function(){
                        getInputsHTML();
                      });
                      break;
                    case "imagen":
                      $el.find("p").remove(); 
                      $el.find("input").attr('id', 'inimage');                   
                      $el.find("input").change(function() {                      
                          if (this.files && this.files[0]) {
                            saveImage(files);
                          }
                      });
                      break;
                    case "color":
                      $el.find("p").remove();
                      $el.find("input").attr('id', 'incolor');                 
                      $('#incolor').colorpicker();                        
                      $('#incolor').on('colorpickerChange', function(event) {
                        let c = event.color.toString();
                        $( "#color" ).data( "data-color", c );
                        $('#preview').css('background-color', c);
                      });
                      break;
                  }

                  // update id
                  var id = $orig.find(":input").attr("id");                  
                  if (id) {
                    id = id.split("-").slice(0,-1).join("-") + "-" 
                      + (parseInt(id.split("-").slice(-1)[0]) + 1);                
                    $orig.find(":input").attr("id", id);
                    $orig.find("label").attr("for", id);
                  }            

                  // tools
                  $('<p class="tools">\
                    <a class="text-primary edit-link">Visualizar<a> | \
                    <a class="text-primary remove-link">Remover</a></p>').appendTo($el);                             

                  var timer = setTimeout(function() {                                        

                    $("#insaludo").focus(function(){
                      $(this).css("background-color", "#EFF0F1");                      
                      active.facturas     = false;                     
                      active.cuerpo       = false;
                      active.from_button  = false;
                      active.saludo       = true; 
                    });

                    $("#insaludo").blur(function(){
                      $(this).css("background-color", "white");
                      if (active.from_button) {
                        active.saludo     = false;
                      }
                    });

                    $("#insaludo").change(function() {
                      getInputsHTML();
                    });

                    $("#infacturas").focus(function(){
                      $(this).css("background-color", "#EFF0F1");
                      active.saludo       = false;                      
                      active.cuerpo       = false;
                      active.from_button  = false;
                      active.facturas     = true;                      
                    });

                    $("#infacturas").blur(function(){
                      $(this).css("background-color", "white");
                      if (active.from_button) {
                        active.facturas = false;
                      }
                    });

                    $("#infacturas").change(function() {
                      getInputsHTML();
                    });

                    clearTimeout(timer);

                  }, 500);


                } else if (window.type=="preview") {

                  switch(name) {
                    case "llamada":
                      $el.find("p").remove();
                      break;
                    case "mensaje":
                      $el.find("p").remove();                   
                      $el.find("input").replaceWith(`<textarea id="incuerpo"></textarea>`);                              
                      $el.find("textarea").removeAttr('placeholder');
                      initTinyEMC();
                      break;
                    case "pagos":
                      $el.find("p").remove();      
                      $('#pagos input[type="checkbox"]').click(function(){
                        getInputsHTML();
                      });
                      break;
                    case "fondo":
                      $el.find("p").remove(); 
                      $el.find("input").attr('id', 'inimage');                   
                      $el.find("input").change(function() {                      
                          if (this.files && this.files[0]) {
                            saveImage(files);
                          }
                      });
                      break;                                          
                    case "color":
                      $el.find("p").remove();
                      $el.find("input").attr('id', 'incolor');                 
                      $('#incolor').colorpicker();                        
                      $('#incolor').on('colorpickerChange', function(event) {
                        let c = event.color.toString();
                        $( "#color" ).data( "data-color", c );
                        $('#preview').css('background-color', c);
                      });
                      break;
                    }

                    // update id
                    var id = $orig.find(":input").attr("id");                  
                    if (id) {
                    id = id.split("-").slice(0,-1).join("-") + "-" 
                      + (parseInt(id.split("-").slice(-1)[0]) + 1);                
                    $orig.find(":input").attr("id", id);
                    $orig.find("label").attr("for", id);
                    }            

                    // tools
                    $('<p class="tools">\
                    <a class="text-primary edit-link">Visualizar<a> | \
                    <a class="text-primary remove-link">Remover</a></p>').appendTo($el);                             

                    var timer = setTimeout(function() {                                        

                      $("#inllamado").focus(function(){
                        $(this).css("background-color", "#EFF0F1");
                        active.saludo = true;                      
                        active.cuerpo = false;
                        active.from_button = false;
                      });

                      $("#llamado").blur(function(){
                        $(this).css("background-color", "white");
                        if (active.from_button) {
                          active.saludo = false;
                        }
                      });

                      $("#insaludo").change(function() {
                        getInputsHTML();
                      });

                      clearTimeout(timer);

                    }, 500);

                }

          }

          function saveImage(files) {
            var reader = new FileReader();            
            reader.onload = function (e) {                              
                
              //target_result = e.target.result;

                let docPath = window.documentPath + "/designs/" + window.designId; 
                let paths = url_path.split("/");
                let _image_ 			= image_name + "_web.png";
                var image_storage  		= url_path.split(paths[4])[0];

                var storageRef = storage.ref("/posts");                                        
                var filePath =  title + ".png";
                const imageRef = storageRef.child(imgName)
                imageRef.put(img)
                .then(snapshot => {
                    return imageRef.getDownloadURL()
                    .then(url => {
                        // url is the download URL
                    })
                })
                .catch(error => {
                    // deal any errors
                });
                getInputsHTML();
            }            
            reader.readAsDataURL(this.files[0]);
          }

          var getInputsHTML = async function () {           

            $("#preview").empty();      
            
            const myPromise = new Promise(async (resolve, reject) => {  

              var count = 0;
              var _html = "";
              var modules = {};

               $('#drop-area').children('div').each(function(index, value) { 
                  
                  try {

                    console.log(`div${index}: ${this.id}`);

                    var value;                                                          
                    var json = {};

                    if (window.type=="web") {
                    
                        switch (this.id) {
                          case "saludo":
                            count++;
                            let insaludo = value = $(this).find("#insaludo").val();
                            let saludo =  `<h3 style="margin-bottom: 50px;"><p class="font-weight-bold">
                                          ${insaludo}</p></h3>`;
                            _html += saludo;                                                                
                            break;
                          case "cuerpo":
                            count++;
                            let inscuerpo = value = tinymce.activeEditor.getContent();
                            let cuerpo =  `<div style="margin-bottom: 40px;">
                                        ${inscuerpo}</div>`;
                            _html += cuerpo;
                            break;
                          case "pagos":
                            count++;                
                            let inMercado = $('#inMercado').prop('checked');
                            let inRapi = $('#inRapi').prop('checked');
                            let inFacil = $('#inFacil').prop('checked');
                            let inOtros = $('#inOtros').prop('checked');                           
                            value = JSON.parse(`{"mercado":${inMercado}, "rapi":${inRapi}, "facil":${inFacil}, "otros":${inOtros}}`);
                            let pagos = getPagos();
                            if (pagos!=undefined) {
                                _html += pagos;
                            }                         
                            break;
                          case "contacto":
                            count++;                
                            let inGrabar    = $('#inGrabar').prop('checked');
                            let inLlamar    = $('#inLlamar').prop('checked');
                            let inWhatsapp  = $('#inWhatsapp').prop('checked');
                            let inEmail     = $('#inEmail').prop('checked');                        
                            value = JSON.parse(`{"rec":${inGrabar}, "call":${inLlamar}, "wa":${inWhatsapp}, "email":${inEmail}}`);
                            let contacto = getContacto();
                            if (contacto!=undefined) {
                                _html += contacto;
                            }                         
                            break;
                          case "facturas":
                            count++;                                            
                            let inDescargar = $('#inDescargar').prop('checked');
                            let inDetalle    = $('#inDetalle').prop('checked');                                                 
                            let inMonto    = $('#inMonto').prop('checked');                                                 
                            let infactura = $(this).find("#infacturas").val();
                            var fact = "";
                            if (infactura!="") {
                              fact = `"tit":"${infactura}",`;
                            }                                                      
                            value = JSON.parse(`{${fact}"des":${inDescargar}, "det":${inDetalle}, "mon":${inMonto}}`);                            
                            let facturas = getFacturas(value, infactura);
                            if (facturas!=undefined) {
                                _html += facturas;
                            }                         
                            break;
                          case "imagen":
                            count++;                       
                            if ( $("#inimagen").val() != undefined ) {
                              let inimagen =  `<div style="width:100%; height:100%">
                                              <img style="margin-left: auto;  margin-right: auto; display: block; width: 50%;"
                                              src="${target_result}"></div>`;
                              _html += inimagen;
                            }
                            break;
                          case "color":
                            count++;  
                            let color = value = $(this).find("#incolor").val();     
                            $('#preview').css('background-color', color);                   
                            break;
                        }        

                        json["value"] = value;                                          
                        json["key"] = this.id;                                          
                        modules[count] = json;                     

                        if (count_drop == count) {                                     

                          let comupulsory = `
                          <footer class="footer">
                            <div class="container">` +
                              /*<hr>
                              <div class="row">
                                <div class="col-sm-2"/>                        
                                <div class="col-sm-8">
                                  <button type="button" class="btn btn-primary col-12">Recibir notificaciones</button>
                                </div>
                                <div class="col-sm-2"/>
                              </div>*/
                              `<hr>              
                              <div class="row">
                                <div class="col-sm-2"/>                        
                                <div class="col-sm-8">
                                  <button type="button" class="btn btn-secondary col-12">No soy esa persona</button>
                                </div>
                                <div class="col-sm-2"/>
                              </div>
                              <br>
                            </div>
                          </footer>`;

                          _html += comupulsory;
                          _html = replaceVariables(_html);
                          $("#preview").html(_html);                                                               

                          resolve([_html, modules]);

                        }  

                      } else if (window.type=="preview") {

                          switch (this.id) {
                            case "llamada":
                              count++;
                              let insaludo = value = $(this).find("#inllamada").val();
                              let llamada =  `<h3 style="margin-bottom: 30px;"><p class="font-weight-bold">
                                            ${llamada}</p></h3>`;
                              _html += llamada;                                                                
                              break;
                            case "mensaje":
                              count++;
                              let inmensaje = value = tinymce.activeEditor.getContent();
                              let mensaje =  `<div style="margin-bottom: 40px;">
                                          ${inmensaje}</div>`;
                              _html += mensaje;
                              break;
                            case "fondo":
                              count++;                
                              let inMercado = $('#inMercado').prop('checked');
                              let inRapi = $('#inRapi').prop('checked');
                              let inFacil = $('#inFacil').prop('checked');
                              let inOtros = $('#inOtros').prop('checked');                           
                              value = JSON.parse(`{"mercado":${inMercado}, "rapi":${inRapi}, "facil":${inFacil}, "otros":${inOtros}}`);
                              let pagos = getPagos();
                              if (pagos!=undefined) {
                                  _html += pagos;
                              }                         
                              break;
                            case "pie":
                              count++;                
                              let inGrabar    = $('#inGrabar').prop('checked');
                              let inLlamar    = $('#inLlamar').prop('checked');
                              let inWhatsapp  = $('#inWhatsapp').prop('checked');
                              let inEmail     = $('#inEmail').prop('checked');                        
                              value = JSON.parse(`{"rec":${inGrabar}, "call":${inLlamar}, "wa":${inWhatsapp}, "email":${inEmail}}`);
                              let contacto = getContacto();
                              if (contacto!=undefined) {
                                  _html += contacto;
                              }                         
                              break;
                            case "color":
                              count++;  
                              let color = value = $(this).find("#incolor").val();     
                              $('#preview').css('background-color', color);                   
                              break;
                          }        

                          json["value"] = value;                                          
                          json["key"] = this.id;                                          
                          modules[count] = json;                     

                          if (count_drop == count) {                                     

                            let comupulsory = `
                            <footer class="footer">
                              <div class="container">` +
                                /*<hr>
                                <div class="row">
                                  <div class="col-sm-2"/>                        
                                  <div class="col-sm-8">
                                    <button type="button" class="btn btn-primary col-12">Recibir notificaciones</button>
                                  </div>
                                  <div class="col-sm-2"/>
                                </div>*/
                                `<hr>              
                                <div class="row">
                                  <div class="col-sm-2"/>                        
                                  <div class="col-sm-8">
                                    <button type="button" class="btn btn-secondary col-12">No soy esa persona</button>
                                  </div>
                                  <div class="col-sm-2"/>
                                </div>
                                <br>
                              </div>
                            </footer>`;

                            _html += comupulsory;
                            _html = replaceVariables(_html);
                            $("#preview").html(_html);                                                               

                            resolve([_html, modules]);

                        }  

                      }
             
                } catch (e) {
                    console.error(e);
                    reject(e);
                }

              });

            });

            return myPromise;

          };        

          function getPagos() {

              var arrayObj = [
                {"image": "mercadopago.png", "id": "inMercado", "value": $('#inMercado').prop('checked')},
                {"image": "rapipago.png", "id": "inRapi", "value": $('#inRapi').prop('checked')},
                {"image": "pagofacil.png", "id": "inFacil", "value": $('#inFacil').prop('checked')},
                {"image": "otros.png", "id": "inOtros", "value": $('#inOtros').prop('checked')},
              ];

              var _array = arrayObj.filter(function(s) { 
                return s.value; 
              });

              count = _array.length;

              if (count==0) {
                return;
              }
              var inpagos = "";

              switch (count) {
                case 1:
                  inpagos = `<div class="row">
                      <div class="col">                         
                      </div>
                      <div class="col-5">
                        <img src="/images/${_array[0].image}"/>
                      </div>
                      <div class="col">                          
                      </div>
                    </div>`;
                  break;
                case 2:
                  inpagos = "";
                  break;
                case 3:
                  inpagos = "";
                  break;
              }
              return inpagos;
          }


          function getContacto() {

            var arrayObj = [
              {"image": "record.png", "id": "inGrabar", "value": $('#inGrabar').prop('checked')},
              {"image": "call.png", "id": "inLlamar", "value": $('#inLlamar').prop('checked')},
              {"image": "whatsapp.png", "id": "inWhatsapp", "value": $('#inWhatsapp').prop('checked')},
              {"image": "gmail.png", "id": "inEmail", "value": $('#inEmail').prop('checked')},
            ];

            var _array = arrayObj.filter(function(s) { 
              return s.value; 
            });

            count = _array.length;

            if (count==0) {
              return;
            }

            var incontactos = "";

            switch (count) {
              case 1:
              incontactos = `<div class="row">
                    <div class="col">                         
                    </div>
                    <div class="col-5">
                      <img src="/images/${_array[0].image}"/>
                    </div>
                    <div class="col">                          
                    </div>
                  </div>`;
                break;
              case 2:
                incontactos = "";
                break;
              case 3:
                incontactos = "";
                break;
            }
            return incontactos;
          }

          function getFacturas(value, infactura) {     
            
            var _html = "";

            if (infactura) {
              _html +=  `<h4 class="pt-3" style="margin-bottom: 30px;"><p class="font-weight-bold">
                                            ${infactura}</p></h4>`;
            }         

            if ( value.des==true || value.det==true || value.mon==true) {

                var today = new Date();
                var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
                var number = "10354";
                var amount  = "$87.000";

                var table = 
                `<table id="field-table" class="pt-1 table table-bordered table-hover table-sm">
                  <thead>
                    <tr>                      
                      <th>
                        Fecha 
                      </th>
                      <th>
                        Numero
                      </th>`;
                      if (value.mon) {                  
                        table += `<th>
                                    Monto 
                                  </th>`; 
                      }                                  
                      if (value.det || value.des) {                  
                        table += `<th>
                                    Acciones 
                                  </th>`;
                      }                                                                                      
                      table +=`</tr>
                  </thead>
                  <tbody>
                    <tr id="field0">
                      <td>
                        ${date}
                      </td>
                      <td>
                        ${number}
                      </td>`;
                      if (value.mon) {                  
                        table += `<td>            
                          ${amount}
                        </td>`;
                      }
                      if (value.det || value.des) {                  
                        table += `<td><div class="row pt-2">`;
                        if (value.det) {
                          table += `<i class="pl-4 fa fa-eye" aria-hidden="true"></i>`;
                        }              
                        if (value.des) {                  
                          table += `<i class="pl-4 fa fa-download" aria-hidden="true"></i>`;
                        }
                        table += `<div></td>`;
                      }                        
                   table += `</tr>                              
                  </tbody>
                </table>`;

                _html += table;

              } 
            
              return _html
          }
        

          function replaceVariables(_html) {
            for (var key of Object.keys(data)) {                
              let nombre = "{" + key + "}";
              let datos = data[key]["datos"];
              _html = _html.replace(nombre, datos);             
            }
            return _html;
          }

          var get_modal = function(content) {
          var modal = $('<div class="modal" style="overflow: auto;" tabindex="-1">\
            <div class="modal-dialog">\
              <div class="modal-content">\
                <div class="modal-header">\
                  <a type="button" class="close"\
                    data-dismiss="modal" aria-hidden="true">&times;</a>\
                  <h4 class="modal-title">Edit HTML</h4>\
                </div>\
                <div class="modal-body ui-front">\
                  <textarea class="form-control" \
                    style="min-height: 200px; margin-bottom: 10px;\
                    font-family: Monaco, Fixed">'+content+'</textarea>\
                  <button class="btn btn-success">Update</button>\
                </div>\
              </div>\
            </div>\
            </div>').appendTo(document.body);            
          return modal;
        };
        
        $(document).on("click", ".edit-link", function(ev) {   
          
          getInputsHTML();
          
          /*var $el = $(this).parent().parent();
          var $el_copy = $el.clone();
          
          var $edit_btn = $el_copy.find(".edit-link").parent().remove();

          var $modal = get_modal(html_beautify($el_copy.html())).modal("show");
          $modal.find(":input:first").focus();
          $modal.find(".btn-success").click(function(ev2) {
            var html = $modal.find("textarea").val();
            if(!html) {
              $el.remove();
            } else {
              $el.html(html);
              $edit_btn.appendTo($el);
            }
            $modal.modal("hide");
            return false;
          });*/

        });       
        
        

          $("#login").text("Logged");

          function initTinyEMC() {  

            var camposFields = {
              one: "first",
              two: "second",
              three: "third"
            };         
            
            /**
             * SAMPLE
             * https://www.tiny.cloud/docs/demo/basic/
             * */

            tinymce.init({
              selector: 'textarea#incuerpo',
              menubar: false,
              height: 200,             
              plugins: [
                'advlist autolink lists link image charmap print preview anchor',
                'searchreplace visualblocks code fullscreen',
                'insertdatetime media table paste code wordcount'
              ],
              toolbar: 'undo redo | formatselect | ' +
              'bold italic backcolor | alignleft aligncenter ' +
              'alignright alignjustify | bullist numlist outdent indent | ' +
              'removeformat',
              content_css: '//www.tiny.cloud/css/codepen.min.css',

              setup: function(editor) {

                editor.on('change', function(ed) {              
                  let _content = editor.getContent();      
                  getInputsHTML();  
                });
                
                /** Campos **/              
                editor.ui.registry.addMenuButton('campos', {
                  text: 'Campos',
                  fetch: function(callback) {
                    var items = [];
                    for (var fieldName in camposFields) {
                      var menuItem = {
                        type: 'menuitem',
                        text: camposFields[fieldName],
                        value:fieldName,
                        onSetup: function(buttonApi) {
                          var $this = this;
                          this.onAction = function() {
                            editor.insertContent($this.data.value);
                          };
                        },
                      };
                      items.push(menuItem);
                    }
                    callback(items);
                  },
                });
              }
            });

            tinymce.activeEditor.on('focus', function(e) {
              active.cuerpo = true;
              active.saludo = false;
              active.from_button = false;               
            });

            tinymce.activeEditor.on('blur', function(e) {                       
              if (active.from_button) {
                active.cuerpo = false;
              }                
            });

          }

        } else  {

        }

      });   

    });  

    /*  tinymce.init({
        language: 'es',
        selector: 'textarea',
        height: 500,
        theme: 'modern',
        plugins: 'print preview fullpage powerpaste searchreplace autolink directionality advcode visualblocks visualchars fullscreen image link template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount a11ychecker imagetools contextmenu colorpicker textpattern wordcount contextmenu help',
        toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat',
        contextmenu: "link image inserttable | cell row column deletetable",
        image_advtab: true,
        templates: [
          { title: 'Test template 1', content: 'Test 1' },
          { title: 'Test template 2', content: 'Test 2' }
        ],
        content_css: [
          '//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
          '//www.tinymce.com/css/codepen.min.css'
        ],
        setup:function(ed) {
          ed.on('change', function(e) {              
              $('#preview').html(ed.getContent());
          });
        },
        mobile: {
          menubar: true
        },

      });*/

      /**
       * 
       * Custom Menu Item
       * //https://www.tiny.cloud/docs/demo/custom-menu-item/
       * 
       * Local Upload
       * https://www.tiny.cloud/docs-4x/demo/local-upload/
       * 
       * Image Upload
       * https://www.tiny.cloud/docs-4x/general-configuration-guide/upload-images/
       * 
       * */
      
    
    //]]>
    </script>

   
   
  </body>
</html>
