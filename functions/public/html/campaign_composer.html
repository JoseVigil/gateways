<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">     
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="stylesheet" href="/vendor/colorPicker/css/bootstrap-colorpicker.css">
     <link rel='icon' href='https://vigil.com.ar/favicons/notimation.ico' type='image/x-icon' />
     
     <title>Noti Campaigns</title>    
    
      <style>  
    
       
     </style>

  </head>

  <body>    

    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/lr9wasio09vwo6la4k91gs8hybva1vp7oxw5k9cfpm2g5pm6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>            
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-functions.js"></script>   

    <script src="https://kit.fontawesome.com/f014efefd7.js" crossorigin="anonymous"></script>

    <script src="/vendor/colorPicker/js/bootstrap-colorpicker.js"></script>

       
    
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-dark bg-dark">
             
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="navbar-toggler-icon"></span>
            </button> <a class="navbar-brand" href="#">Brand</a>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="navbar-nav">
                <li class="nav-item active">
                   <a class="nav-link" href="#">Link <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                   <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown">Dropdown link</a>
                  <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                     <a class="dropdown-item" href="#">Action</a> <a class="dropdown-item" href="#">Another action</a> <a class="dropdown-item" href="#">Something else here</a>
                    <div class="dropdown-divider">
                    </div> <a class="dropdown-item" href="#">Separated link</a>
                  </div>
                </li>
              </ul>
              <form class="form-inline">
                <input class="form-control mr-sm-2" type="text" /> 
                <button class="btn btn-primary my-2 my-sm-0" type="submit">
                  Search
                </button>
              </form>
              <ul class="navbar-nav ml-md-auto">
                <li class="nav-item active">
                   <a class="nav-link" href="#">Link <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item dropdown">
                   <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown">Dropdown link</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                     <a class="dropdown-item" href="#">Action</a> <a class="dropdown-item" href="#">Another action</a> <a class="dropdown-item" href="#">Something else here</a>
                    <div class="dropdown-divider">
                    </div> <a class="dropdown-item" href="#">Separated link</a>
                  </div>
                </li>
              </ul>
            </div>
          </nav>

          <br>

          <div class="row">
            <div id="login">
              Not Logged
            </div>  
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
              <h3 class="text-center">
                Noti Designer
              </h3>
            </div>
            <div class="col-md-4">
            </div>
          </div>

          <br>
          
          <div class="row">

            <div class="col-md-12">              

              <div class="row">                

                <!--NEW CAMPAIGN-->
                <div class="col-md-6">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-6">
                           <span class="badge badge-default float-right"><h5>Nombre campaña:</h5></span>
                        </div>
                        <div class="col-md-6">
                          <input id="campaign-name" type="text" class="form-control">
                          <p>Crea el cuerpo del mensaje</p>                                    
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="row float-right">
                            <span class="badge badge-default"><h5>Agregar campo</h5></span>
                            <button id="add-field" type="button" class="btn btn-success ">
                              +
                            </button>
                          </div>
                        </div>
                        <div class="col-md-6">                           
                          
                          <label class="btn btn-default">
                            Subir archivo de Excel <input id="excel-file" type="file" hidden>
                            <i class="fas fa-file-excel"></i>
                          </label>
                        </div>
                      </div>
                      <br>
                      <div class="row">
                        <div class="col-md-12">

                          <table id="field-table" class="table table-bordered table-hover table-sm">
                            <thead>
                              <tr>
                                <th>                                  
                                </th>
                                <th>
                                  Campo
                                </th>
                                <th>
                                  Valor
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr id="field1">
                                <td>
                                  <span class="glyphicon glyphicon-envelope"></span>                                </td>
                                <td>
                                  <input id="name_1" type="text" class="form-control">
                                </td>
                                <td>
                                  <input id="value_1" type="text" class="form-control">
                                </td>                               
                              </tr>                              
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-6">
                           
                          <button type="button" class="btn btn-success">
                            Borrar
                          </button>
                        </div>
                        <div class="col-md-6">
                           
                          <button id="save-campaign" type="button" class="btn btn-success">
                            Guardar Campaña
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                
                <!--TABLE-->
                <div class="col-md-6">
                  <table id="campaign-table"  class="table table-bordered table-hover table-sm">
                    <thead>
                      <tr>
                        <th>
                            <span class="custom-checkbox">
                                <input type="checkbox" id="selectAll">
                                <label for="selectAll"></label>
                            </span>
                        </th>
                        <th>Nombre</th>
                        <th>Actualizada</th>,.                        
                        <th></th>                        
                    </tr>
                    </thead>
                    <tbody>
                    
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <h3>
                Campañas
              </h3>
              <div class="row">
                <div class="col-md-4">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-8">
                        </div>
                        <div class="col-md-4">
                           
                          <button type="button" class="btn btn-success">
                            Cerrar
                          </button>
                        </div>
                      </div>
                      <h3>
                        h3. Lorem ipsum dolor sit amet.
                      </h3><img alt="Bootstrap Image Preview" src="https://www.layoutit.com/img/sports-q-c-140-140-3.jpg" />
                      <div class="row">
                        <div class="col-md-12">
                        </div>
                      </div><img alt="Bootstrap Image Preview" src="https://www.layoutit.com/img/sports-q-c-140-140-3.jpg" />
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                </div>
                <div class="col-md-4">
                </div>
              </div>
            </div>
          </div>

          <!-- Add Alert -->  
          <div id="alertModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">                                
                    <div class="modal-body">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <p id="alert-content"></p>
                    </div>                                
                    <div data-dismiss="modal" class="modal-footer"><button type="button" class="btn btn-primary">OK</button></div>
                </div>
            </div>
        </div>


          
        </div>
      </div>
    </div>


    

    <script>
    //<![CDATA[


    /**
     * PDF TO HTML
     * 
     * https://www.idrsolutions.com/online-pdf-to-html5-converter
     * 
     * */

    /**
     * Drag and drop
     * http://jsfiddle.net/vacidesign/uskx816g/
     * */

    /**
     * jquery Uncaught SyntaxError: "Unexpected token '<'"
     * https://idiallo.com/javascript/uncaught-syntaxerror-unexpected-token#n
     * 
     * */

    /**
     * Stepper into modal
     * 
     * https://bbbootstrap.com/snippets/modal-dialog-multi-step-form-wizard-29726524
     * */

    $(document).ready(function () {  

      var client = "sipef";

      var active_saludo = false;
      var active_cuerpo = false;
      var active_from_button = false;

      var target_result;

      var data;
      var count_drop = 0;

      var count_field = 1;

      const firebaseConfig = {
        apiKey: "AIzaSyAM4WQDHpHh1oRT_v-6ikquE4V809hA3kY",
        authDomain: "notims.firebaseapp.com",
        databaseURL: "https://notims.firebaseio.com",
        projectId: "notims",
        storageBucket: "notims.appspot.com",
        messagingSenderId: "79471870593",
        appId: "1:79471870593:web:ef29a72e1b1866b2bb4380",
        measurementId: "G-8T5N81L78J"
      };
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      const database = firebase.database();
      const functions = firebase.functions();

      var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
      };           
    
      $( "#login" ).click(function() {       

        firebase.auth().signInWithEmailAndPassword("josemanuelvigil@gmail.com", "temporary").then(function(user) {                      
          window.location.reload();            
        }).catch( function(error) {                         
            var errorMessage = error.message;  
            console.log(errorMessage);
        });

      });
      
      
      firebase.auth().onAuthStateChanged(function (user) {

        if (user) { 

          var documentId = getUrlParameter('id'); 
          
          db.collection('clients')
          .doc(client)
          .collection("campaigns")
          .onSnapshot(snapshot => {
            
              let size = snapshot.size;            
              let changes = snapshot.docChanges();
              changes.forEach(change => {
                  
                  let document = change.doc;
                  let id = document.id;                  
                  let last_update = document.data().last_update;                  
                  
                  let item = `<tr data-id="${document.id}">
                  <td>
                      <span class="custom-checkbox">
                          <input type="checkbox" id="check_${document.id}" name="options[]" value="${document.id}">
                          <label for="${document.id}"></label>
                      </span>
                  </td>
                  <td>${document.data().name}</td>
                  <td>${document.data().last_update}</td>               
                  <td><a href="#" id="menu_${document.id}"><i class="fal fa-ellipsis-v"></i></a></td>        
                  </tr>`;
                  $('#campaign-table').append(item);
                 
              });
          });
        }

      });  


      $("#add-field").on('click', function() {  

          count_field++;

          let item = `<tr id="field${count_field+1}">
            <td>
              <span class="glyphicon glyphicon-envelope"></span>                                </td>
            <td>
              <input id="name_${count_field}" type="text" class="form-control">
            </td>
            <td>
              <input id="value_${count_field}" type="text" class="form-control">
            </td>                               
          </tr>`;   
          $('#field-table').append(item); 

      });   

      $("#save-campaign").on('click', function() {  

        let _table_size = $("#field-table tr").length - 1;

       var count = 0;
       var fields_array = [];
       var _break = false;
        
        $("#field-table tr").each(function() {
          if (_break==false) {
            count++;
            let _name = $("#name_"+count).val();
            let _value = $("#value_"+count).val(); 
            let _field = {
              "name":_name,
              "value":_value
            };   
            fields_array.push(_field);
            if (count == _table_size) {
              saveCampaig(fields_array);
              _break = true;
            } 
          }
        });      
      
      });

      function saveCampaig(fields_array) {

        var campaign_name = $("#campaign-name").val();

        var cname = campaign_name.split(' ').join('_');

        var _time =  new Date();
        
        db.collection('clients')
          .doc(client)
          .collection("campaigns")
          .doc(cname)
          .set({        
            name: campaign_name,
            last_update: _time,      
            time_created: _time,
            fields:fields_array            
          },{ merge:true }).then(docRefSet => {                
              

              let _files = document.getElementById("excel-file").files;

              if (_files.length>0) {
                  
                  var storageRef = storage.ref(path);       
                    
                  var filePath =  "jose.xls";        
                  var thisRef = storageRef.child(filePath);    

                  var file = [0]; 
                  var input = this;
                  var length = input.files.length;
                  var _file = input.files.item(0); 
                  
                  var metadataFiles = {
                    customMetadata: {                
                        'type': 'xls',
                        'documentId' : cname,
                        "path" : path                        
                    }
                  };

                  var file = document.getElementById("excel-file").files[0];   
                  var filePathMuseum = "jose.xlsx";        
                  const museumRef = storageRef.child(filePathMuseum);
                  var putRef = museumRef.put(_file, metadataFiles);          
                  putRef.on('state_changed', function(snapshot) {
                      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                      console.log('Upload is ' + progress + '% done');
                      switch (snapshot.state) {
                        case firebase.storage.TaskState.PAUSED: // or 'paused'
                          console.log('Upload is paused');
                          break;
                        case firebase.storage.TaskState.RUNNING: // or 'running'
                          console.log('Upload is running');
                          break;
                      }
                    }, function(error) {
                      // Handle unsuccessful uploads
                    }, function() { 


                      
                      $('#alertModal').modal('show');                      
                   });

              } else {                

                $('#alert-content').text('La campaña ' + campaign_name + ' ha sido creada con exito.');
                $('#alertModal').modal('show');

              }
            
          }).catch((error) => {     
            console.error("Error adding document: ", error);           
          });   
       

      }

      $("#excel-file").on('change', function() {});

    });  
      
    </script>  
   
  </body>
</html>
