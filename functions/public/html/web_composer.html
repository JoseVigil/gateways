<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">     
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="stylesheet" href="/vendor/colorPicker/css/bootstrap-colorpicker.css">
     <link rel='icon' href='https://vigil.com.ar/favicons/notimation.ico' type='image/x-icon' />
     
     <title>Noti.ms</title>
  
      <style>  
    
        .column-background {
          background-color: #fff; border-radius: 5px; padding: 20px; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        }

        .droppable-active { background-color: #ffe !important; }
        .tools a { cursor: pointer; font-size: 80%; }
        .form-body .col-md-6, .form-body .col-md-12 { min-height: 800px; }
        .draggable { cursor: move; }

        hr {
          margin-top: 1rem;
          margin-bottom: 1rem;
          border: 0;
          border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .checkbox {
          padding-left: 10px;
          padding-right: 10px;
        }
        
        .form-composer {
          padding-left:15px;
        }        
      
     </style>

  </head>

  <body>       
     
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/lr9wasio09vwo6la4k91gs8hybva1vp7oxw5k9cfpm2g5pm6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>            
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-functions.js"></script>   


    <script src="/vendor/colorPicker/js/bootstrap-colorpicker.js"></script>

    <div id="login">
      Not Logged
    </div>  
    
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3">
          <div class="column-background">
            <div class="tabbable" id="tabs-381741">
              <ul class="nav nav-tabs">
                <li class="nav-item">
                  <a class="nav-link active" href="#tab1" data-toggle="tab">Section 1</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#tab2" data-toggle="tab">Section 2</a>
                </li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane active">

                  <form id="form-composer" role="form">

                    <br>

                    <div id="saludo" class="form-group draggable">
                      <label for="saludo" ><b>Saludo</b></label>
                      <input type="text" class="form-control" id="insaludo">
                      <p class="help-block">Saludo de cortecia</p>
                    </div>
                   
                    <div id="cuerpo" class="form-group draggable">
                      <label for="cuerpo" ><b>Cuerpo</b></label>  
                      <input type="text" class="form-control">
                      <p>Crea el cuerpo del mensaje</p>                        
                    </div>  
                    
                    <!--<div id="imagen" class="form-group draggable">
                      <label for="imagen" ><b>Imagen</b></label>
                      <input id="inimagen" type="file" name="files[]">
                      <p class="help-block">Agregar imagen</p>
                    </div>-->

                    <div class="form-group draggable">
                      <label for="contacto" ><b>Contacto</b></label>
                      <div class="control-group">                        
                        <div class="controls span2">
                            <label class="checkbox">
                              <input type="checkbox" id="inlineCheckbox1"> Grabar mensaje
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inlineCheckbox1"> Llamame
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inlineCheckbox2"> Whatsapp
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="inlineCheckbox3"> Email
                            </label>                            
                        </div>                        
                      </div>
                      <p class="help-block">Modo de contacto</p>
                    </div>

                    <div id="pagos" class="form-group draggable">
                      <label for="pagos" ><b>Pagos</b></label>
                      <input type="text" class="form-control" id="inpagos">
                      <div class="control-group">                        
                        <div class="controls">
                            <div class="row">
                              <label class="checkbox">
                                  <input type="checkbox" id="inMercado"> Mercadopago
                              </label>                              
                              <label class="checkbox">
                                  <input type="checkbox" id="inRapi"> Rapipago
                              </label>
                            </div>
                            <div class="row">
                              <label class="checkbox">
                                  <input type="checkbox" id="inFacil"> Pago Facil
                              </label>
                              <label class="checkbox">
                                <input type="checkbox" id="inOtros"> Otros
                              </label>           
                            </div>                   
                        </div>                        
                    </div>                                                          
                      <p class="help-block">Medio de pago</p>
                    </div>

                   

                  <div class="form-group draggable">
                    <label for="color" ><b>Color de fondo</b></label>                   
                    <input type="text" value="rgb(255, 128, 0)" />
                    <p class="help-block">Cambiar color de fondo</p>                    
                  </div>
                  
                  </form>

                </div>
                <div class="tab-pane" id="tab2">
                  <p>
                    Howdy, I'm in Section 2.
                  </p>
                </div>
              </div>
            </div>

          </div>          
        </div>
        <div class="col-md-5">

          <div class="column-background" style="font-size: 15px;">
            <label>Arrastrar y soltar elementos.</label>
            <div class="row" id="composer"></div>
            <hr/>
            <div class="row form-body">
              <div class="col-md-12 droppable sortable">
              </div>              
            </div>

        </div>
          
        </div>       
        <div class="col-md-4">
          <div class="column-background">
            <div class="form-group draggable">
              <div id="preview">            
                
              </div>
            </div>
          </div>
        </div>
      </div>
     
    </div>

    <script>
    //<![CDATA[


    /**
     * PDF TO HTML
     * 
     * https://www.idrsolutions.com/online-pdf-to-html5-converter
     * 
     * */

    /**
     * Drag and drop
     * http://jsfiddle.net/vacidesign/uskx816g/
     * */

    /**
     * jquery Uncaught SyntaxError: "Unexpected token '<'"
     * https://idiallo.com/javascript/uncaught-syntaxerror-unexpected-token#n
     * 
     * */

    /**
     * Stepper into modal
     * 
     * https://bbbootstrap.com/snippets/modal-dialog-multi-step-form-wizard-29726524
     * */

    $(document).ready(function () {  

      var active_saludo = false;
      var active_cuerpo = false;
      var active_from_button = false;

      var target_result;

      var data;
      var count_drop = 0;

      const firebaseConfig = {
        apiKey: "AIzaSyAM4WQDHpHh1oRT_v-6ikquE4V809hA3kY",
        authDomain: "notims.firebaseapp.com",
        databaseURL: "https://notims.firebaseio.com",
        projectId: "notims",
        storageBucket: "notims.appspot.com",
        messagingSenderId: "79471870593",
        appId: "1:79471870593:web:ef29a72e1b1866b2bb4380",
        measurementId: "G-8T5N81L78J"
      };
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      const database = firebase.database();
      const functions = firebase.functions();

      var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
      };           
    
      $( "#login" ).click(function() {       

        firebase.auth().signInWithEmailAndPassword("josemanuelvigil@gmail.com", "temporary").then(function(user) {                      
          window.location.reload();            
        }).catch( function(error) {                         
            var errorMessage = error.message;  
            console.log(errorMessage);
        });

      });        
    
      firebase.auth().onAuthStateChanged(function (user) {

        if (user) { 

          var documentId = getUrlParameter('id'); 

          db.collection("cobranzas").doc(documentId)
            .get()
            .then(function(doc) {

              var name =  doc.data().name;                
              var code =  doc.data().code;
              var contact =  doc.data().contact;                
              
              data = { 
                "nombre" :  { 
                  "datos" : name, 
                  "boton" : "btn-primary" 
                }, 
                "codigo" :  { 
                  "datos" : code, 
                  "boton" : "btn-secondary" 
                }, 
                "contacto" :  { 
                  "datos" : contact, 
                  "boton" : "btn-success" 
                }               
              };

              for (var key of Object.keys(data)) {
                
                let nombre = key;
                let datos = data[key]["datos"];
                let boton = data[key]["boton"];

                let _html = `&nbsp;&nbsp<button data-field="${datos}" style="color:white" class="botones btn ${boton}" type="button" id="${nombre}">${nombre}</button>&nbsp;&nbsp`;
           
                $("#composer").append(_html);

                $("#" + nombre).on('click', function (e) {                     
                  e.preventDefault();

                  active_from_button = true;

                  var timer_click = setTimeout(function() {                                                           
                  
                    var id = $(e.target).attr('id'); 
                    var variable;

                    if (id=="nombre") {
                      variable = "{nombre}";                     
                    } else if (id=="codigo") {
                      variable = "{codigo}";  
                    } else if (id=="contacto") {
                      variable = "{contacto}";
                    }

                    if (active_saludo) {

                      var cursorPos = $('#insaludo').prop('selectionStart');
                      var v = $('#insaludo').val();
                      var textBefore = v.substring(0,  cursorPos );
                      var textAfter  = v.substring( cursorPos, v.length );
                      $('#insaludo').val( textBefore + variable + textAfter ); 

                    } else if (active_cuerpo) {                                                      
                      tinymce.activeEditor.execCommand('mceInsertContent', false, variable);
                    }  

                    clearTimeout(timer_click);

                  }, 1000);

                });
              }
          });            
       
          $( ".draggable" ).draggable({
            appendTo: "body",
            helper: "clone"
          });
          
          $( ".droppable" ).droppable({
            accept: ".draggable",
            helper: "clone",
            hoverClass: "droppable-active",
            drop: function( event, ui ) {
              
              $(".empty-form").remove();
              var $orig = $(ui.draggable);
              
              if(!$(ui.draggable).hasClass("dropped")) {

                count_drop++;

                var name = $orig.find("label").attr("for");                      
                
                var $el = $orig
                  .clone()
                  .addClass("dropped")
                  .css({"position": "static", "left": null, "right": null})
                  .appendTo(this);

                if (name=="saludo") {                  
                  $el.find("p").remove();                                     
                }

                if (name=="cuerpo") {                  
                  $el.find("p").remove();                   
                  $el.find("input").replaceWith(`<textarea id="incuerpo"></textarea>`);                              
                  $el.find("textarea").removeAttr('placeholder');
                  initTinyEMC();
                }                

                /*if (name=="imagen") { 
                  $el.find("p").remove(); 
                  $el.find("input").attr('id', 'inimage');  
                  
                  $el.find("input").change(function() {                      
                      if (this.files && this.files[0]) {
                          var reader = new FileReader();            
                          reader.onload = function (e) {                              
                              target_result = e.target.result;
                              getHTML();
                          }            
                          reader.readAsDataURL(this.files[0]);
                      }
                  });
                }*/

                if (name=="contacto") {
                 $el.find("p").remove();           
                }

                if (name=="pagos") {
                  $el.find("p").remove();      
                  $('#pagos input[type="checkbox"]').click(function(){
                    getHTML();
                  });     
                }
               
                if (name=="color") {                              
                  $el.find("p").remove();
                  $el.find("input").attr('id', 'incolor');                 
                  $('#incolor').colorpicker();                        
                  $('#incolor').on('colorpickerChange', function(event) {
                    $('#preview').css('background-color', event.color.toString());
                  });
                }

                // update id
                var id = $orig.find(":input").attr("id");
                
                if(id) {
                  id = id.split("-").slice(0,-1).join("-") + "-" 
                    + (parseInt(id.split("-").slice(-1)[0]) + 1);                
                  $orig.find(":input").attr("id", id);
                  $orig.find("label").attr("for", id);
                }            

                // tools
                $('<p class="tools">\
                  <a class="text-primary edit-link">Visualizar<a> | \
                  <a class="text-primary remove-link">Remover</a></p>').appendTo($el);                             

                var timer = setTimeout(function() {                                        

                  $("#insaludo").focus(function(){
                    $(this).css("background-color", "#EFF0F1");
                    active_saludo = true;                      
                    active_cuerpo = false;
                    active_from_button = false;
                  });

                  $("#insaludo").blur(function(){
                    $(this).css("background-color", "white");
                    if (active_from_button) {
                      active_saludo = false;
                    }
                  });

                  $("#insaludo").change(function() {
                    getHTML();
                  });

                  clearTimeout(timer);

                }, 500);
               
              } else {
               
                if($(this)[0]!=$orig.parent()[0]) {
                
                  var $el = $orig
                    .clone()
                    .css({"position": "static", "left": null, "right": null})
                    .appendTo(this);
                  $orig.remove();

                }
              }
            }
          }).sortable();

          function getHTML() {

            var count = 0;
            var _html = "";

            $("#preview").empty(); 

            $('.draggable').each(function(index, value) { 


              try {
              
                console.log(`div${index}: ${this.id}`);              

                if (this.id == "saludo") {
                  count++;
                  let insaludo = $("#insaludo").val();
                  let saludo =  `<h3 style="margin-bottom: 50px;"><p class="font-weight-bold">
                                ${insaludo}</p></h3>`;
                  _html += saludo;
                } 
                
                if (this.id=="cuerpo") {                              
                  count++;
                  let inscuerpo = tinymce.activeEditor.getContent();
                  let cuerpo =  `<div style="margin-bottom: 40px;">
                              ${inscuerpo}</div>`;
                  _html += cuerpo;
                } 
                
                /*if (this.id=="imagen") {
                  count++;
                  if ($("#inimagen").val()!=undefined) {
                    let inimagen =  `<div style="width:100%; height:100%">
                                    <img style="margin-left: auto;  margin-right: auto; display: block; width: 50%;"
                                    src="${target_result}"></div>`;
                    _html += inimagen;
                  }
                }*/ 

                if (this.id=="pagos") {
                  count++;                
                  //let inMercado = $('#inMercado').prop('checked');
                  //let inRapi = $('#inRapi').prop('checked');
                  //let inFacil = $('#inFacil').prop('checked');
                  let inpagos = getPagos();
                  if (inpagos!=undefined) {
                      _html += inpagos;
                  }                
                } 

                if (count_drop == count) {               

                  let comupulsory = `
                  <footer class="footer">
                    <div class="container">
                      <hr>
                      <div class="row">
                        <div class="col-sm-2"/>                        
                        <div class="col-sm-8">
                          <button type="button" class="btn btn-primary col-12">Recibir notificaciones</button>
                        </div>
                        <div class="col-sm-2"/>
                      </div>     
                      <hr>              
                      <div class="row">
                        <div class="col-sm-2"/>                        
                        <div class="col-sm-8">
                          <button type="button" class="btn btn-secondary col-12">No soy esa persona</button>
                        </div>
                        <div class="col-sm-2"/>
                      </div>
                    </div>
                  </footer>`;

                  _html += comupulsory;

                  $("#preview").html(replaceVariables(_html));                 

                  return false;
               }


              } catch (e) {
                  console.error(e);
                  return e;
              }

            });
          };

          function getPagos() {

              var arrayObj = [
                {"image": "mercadopago.png", "id": "inMercado", "value": $('#inMercado').prop('checked')},
                {"image": "rapipago.png", "id": "inRapi", "value": $('#inRapi').prop('checked')},
                {"image": "pagofacil.png", "id": "inFacil", "value": $('#inFacil').prop('checked')},
                {"image": "otros.png", "id": "inOtros", "value": $('#inOtros').prop('checked')},
              ];

              var _array = arrayObj.filter(function(s) { 
                return s.value; 
              });

              count = _array.length;

              if (count==0) {
                return;
              }
              var inpagos = "";

              switch (count) {
                case 1:
                  inpagos = `<div class="row">
                      <div class="col">                         
                      </div>
                      <div class="col-5">
                        <img src="/images/${_array[0].image}"/>
                      </div>
                      <div class="col">                          
                      </div>
                    </div>`;
                  break;
                case 2:
                  inpagos = "";
                  break;
                case 3:
                  inpagos = "";
                  break;
              }

              return inpagos;

          }
        

          function replaceVariables(_html) {
            for (var key of Object.keys(data)) {                
              let nombre = "{" + key + "}";
              let datos = data[key]["datos"];
              _html = _html.replace(nombre, datos);             
            }
            return _html;
          }

          var get_modal = function(content) {
          var modal = $('<div class="modal" style="overflow: auto;" tabindex="-1">\
            <div class="modal-dialog">\
              <div class="modal-content">\
                <div class="modal-header">\
                  <a type="button" class="close"\
                    data-dismiss="modal" aria-hidden="true">&times;</a>\
                  <h4 class="modal-title">Edit HTML</h4>\
                </div>\
                <div class="modal-body ui-front">\
                  <textarea class="form-control" \
                    style="min-height: 200px; margin-bottom: 10px;\
                    font-family: Monaco, Fixed">'+content+'</textarea>\
                  <button class="btn btn-success">Update</button>\
                </div>\
              </div>\
            </div>\
            </div>').appendTo(document.body);
            
          return modal;
        };
        
        $(document).on("click", ".edit-link", function(ev) {   
          
          getHTML();
          
          /*var $el = $(this).parent().parent();
          var $el_copy = $el.clone();
          
          var $edit_btn = $el_copy.find(".edit-link").parent().remove();

          var $modal = get_modal(html_beautify($el_copy.html())).modal("show");
          $modal.find(":input:first").focus();
          $modal.find(".btn-success").click(function(ev2) {
            var html = $modal.find("textarea").val();
            if(!html) {
              $el.remove();
            } else {
              $el.html(html);
              $edit_btn.appendTo($el);
            }
            $modal.modal("hide");
            return false;
          });*/

        });
        
        $(document).on("click", ".remove-link", function(ev) {
          $(this).parent().parent().remove();
          count_drop--;
        });
        

          $("#login").text("Logged");

          function initTinyEMC() {  

            var camposFields = {
              one: "first",
              two: "second",
              three: "third"
            };         
            
            /**
             * SAMPLE
             * https://www.tiny.cloud/docs/demo/basic/
             * */

            tinymce.init({
              selector: 'textarea#incuerpo',
              menubar: false,
              height: 200,             
              plugins: [
                'advlist autolink lists link image charmap print preview anchor',
                'searchreplace visualblocks code fullscreen',
                'insertdatetime media table paste code wordcount'
              ],
              toolbar: 'undo redo | formatselect | ' +
              'bold italic backcolor | alignleft aligncenter ' +
              'alignright alignjustify | bullist numlist outdent indent | ' +
              'removeformat',
              content_css: '//www.tiny.cloud/css/codepen.min.css',

              setup: function(editor) {

                editor.on('change', function(ed) {              
                  let _content = editor.getContent();      
                  getHTML();  
                });
                
                /** Campos **/              
                editor.ui.registry.addMenuButton('campos', {
                  text: 'Campos',
                  fetch: function(callback) {
                    var items = [];
                    for (var fieldName in camposFields) {
                      var menuItem = {
                        type: 'menuitem',
                        text: camposFields[fieldName],
                        value:fieldName,
                        onSetup: function(buttonApi) {
                          var $this = this;
                          this.onAction = function() {
                            editor.insertContent($this.data.value);
                          };
                        },
                      };
                      items.push(menuItem);
                    }
                    callback(items);
                  },
                });
              }
            });

            tinymce.activeEditor.on('focus', function(e) {
              active_cuerpo = true;
              active_saludo = false;
              active_from_button = false;               
            });

            tinymce.activeEditor.on('blur', function(e) {                       
              if (active_from_button) {
                active_cuerpo = false;
              }                
            });

          }

        } else  {

        }

      });   

    });  

    /*  tinymce.init({
        language: 'es',
        selector: 'textarea',
        height: 500,
        theme: 'modern',
        plugins: 'print preview fullpage powerpaste searchreplace autolink directionality advcode visualblocks visualchars fullscreen image link template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount a11ychecker imagetools contextmenu colorpicker textpattern wordcount contextmenu help',
        toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat',
        contextmenu: "link image inserttable | cell row column deletetable",
        image_advtab: true,
        templates: [
          { title: 'Test template 1', content: 'Test 1' },
          { title: 'Test template 2', content: 'Test 2' }
        ],
        content_css: [
          '//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
          '//www.tinymce.com/css/codepen.min.css'
        ],
        setup:function(ed) {
          ed.on('change', function(e) {              
              $('#preview').html(ed.getContent());
          });
        },
        mobile: {
          menubar: true
        },

      });*/

      /**
       * 
       * Custom Menu Item
       * //https://www.tiny.cloud/docs/demo/custom-menu-item/
       * 
       * Local Upload
       * https://www.tiny.cloud/docs-4x/demo/local-upload/
       * 
       * Image Upload
       * https://www.tiny.cloud/docs-4x/general-configuration-guide/upload-images/
       * 
       * */
      
    
    //]]>
    </script>

   
   
  </body>
</html>
